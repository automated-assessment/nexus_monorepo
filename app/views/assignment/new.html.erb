<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<div class="well">
  <h2>Create Assignment</h2>
  <h4 class="course-title"><%= icon 'book' %> <%= link_to @assignment.course.title, @assignment.course %></h4>
  <hr />
  <%= form_for(@assignment, url: create_assignment_path, html: { class: 'form-horizontal' }) do |f| %>

    <%= f.hidden_field :course_id, value: @assignment.course.id %>

    <%= render 'form_metadata', f: f %>

    <hr />
    <h4>Marking Tools</h4>
    <p>
      Tools can be given a weighting of <strong>0%</strong> to be used for feedback only; not contributing to the final mark.
    </p>
    <br />

    <div class="marking-tools">
      <%= f.fields_for :marking_tool_contexts do |ff| %>
        <%= render 'marking_tool_context_fields', f: ff%>

        <div class="add-tool-link">
          <%= link_to_add_association f, :marking_tool_contexts, partial: 'marking_tool_context_fields' do |link| %>
            <%= icon 'plus-circle' %> Add Tool
          <% end %>
        </div>
      <% end %>
    </div>

    <hr>
    <br />
    
    <script>	  
	  var paramCounter = 1;
	  function addInput(divName){
	    paramCounter++;
	    var additionHTML = `<label class='col-lg-2 control-label' for='parameter pair ` + paramCounter + `'>Parameter Pair ` + paramCounter + `</label>
		   	    <div id="pair` + paramCounter + `" class='col-lg-10'>
			        <label class="col-lg-2 control-label" for="parameter name">Parameter Name</label>
				    <input type='text' name='param_name' id='param_name_` + paramCounter + `'><br/>
				    <label class="col-lg-2 control-label" for="parameter type">Parameter Type</label>
					<select id='param_name_` + paramCounter + `'>
					  <option value="1">int</option>
					  <option value="2">float</option>
					  <option value="3">double</option>
					  <option value="4">string</option>
					  <option value="5">boolean</option>
					</select><br/>
					<label class="col-lg-2 control-label" for="parameter constructs">Parameter Constructs</label>
				    <input type='text' name='param_constructs' id='param_constructs_` + paramCounter + `'><br/>
			    </div>`;
	    document.getElementById(divName).innerHTML = document.getElementById(divName).innerHTML + additionHTML;
	  }

	  
	  function taskFunction(){
	    sendParamsToUat();
	  	checkMarkingTools();
	  }
   
      function checkMarkingTools() {
        if (document.getElementById("assignment_marking_tool_contexts_attributes_0_marking_tool_id").selectedIndex != 0) {
          return true;
        } else {
          return confirm("Are you sure you want to create an assignment without marking tools?");
        }
      }
	  
	  function sendParamsToUat() {
	    var isUniqueFlag = document.getElementById('isuniqueflag').checked;
        if(isUniqueFlag == true) {
			var parameterString = "";
			var paramSendCounter = 1;
			var mainDivChildren = document.getElementById("paramField").children;
			for(var i = 0; i < mainDivChildren.length; i++) {
				if(mainDivChildren[i].id.indexOf('pair') == 0) {
					var innerDivChildren = mainDivChildren[i].children;
					for(var j = 0; j < innerDivChildren.length; j++) {
						if(innerDivChildren[j].id.indexOf('param_name_') == 0) {
							parameterString = parameterString.concat(innerDivChildren[j].value + ":");
						}
						else if(innerDivChildren[j].id.indexOf('param_type_') == 0) {
							parameterString = parameterString.concat(innerDivChildren[j].options[innerDivChildren[j].selectedIndex].text + ":");
						}
						else if((innerDivChildren[j].id.indexOf('param_constructs_') == 0) && (paramSendCounter != paramCounter)) {
							parameterString = parameterString.concat(innerDivChildren[j].value + "|");
							paramSendCounter++;
						}
						else if((innerDivChildren[j].id.indexOf('param_constructs_') == 0) && (paramSendCounter == paramCounter)) {
							parameterString = parameterString.concat(innerDivChildren[j].value);
						}
					}
				}
			}  
			try {
				var request = new XMLHttpRequest();
				var params = `parameter_string=${parameterString}`;
				request.open('POST', 'http://localhost:3009/param_upload_start', true);
				request.onreadystatechange = function() {if (request.readyState==4) confirm(document.getElementById("assign_id").value);};
				request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				request.withCredentials = true;
				request.send(params);
			}
			catch (err) {
				confirm(err);
			}
		}
	  }
    </script>

    <div class="form-group">
      <div class="col-lg-10 col-lg-offset-2">
        <%= f.submit 'Create', class: 'btn btn-primary', onclick: "taskFunction()" %>
      </div>
    </div>
  <% end %>
  <br />
</div>
